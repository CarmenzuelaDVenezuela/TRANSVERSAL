class EscenaDeCarga {

  // ===== VARIABLES =====
  float cx, cy;
  float radio;

  float factor = 1.01;

  PImage fondo, relojIn, aguja1, aguja2;

  float angulo = 0;

  // Velocidades
  float velocidadBase = 0.0015;
  float velocidad = velocidadBase;

  // Aceleración
  float factorAceleracion = 1.02;
  boolean acelerando = false;
  int tiempoInicioAceleracion = -1;
  int duracionAceleracion = 8000;

  int ultimoClick = 0;
  int intervaloDobleClick = 300;

  // ===== ANIMACIÓN =====
  final int ANIM_FPS = 8;
  final int FRAME_INTERVAL = 1000 / ANIM_FPS;
  int numFrames = 5;
  int currentFrame = 0;
  PImage[] images = new PImage[numFrames];
  boolean animPlaying = false;
  boolean animFinished = false;
  int lastFrameTime = 0;

  // ===== AUDIO =====
  AudioPlayer edc;

  int estado = INIT;

  // ===== CONSTRUCTOR =====
  EscenaDeCarga() {
    cx = width - width / 4;
    cy = height / 2;
    radio = min(width, height) * 0.35;

    edc = audioManager.loadFile("edc.mp3");

    imageMode(CENTER);

    fondo   = loadResizedImage("edc.png", width);
    relojIn = loadResizedImage("relojc.png", 1000);
    aguja1  = loadResizedImage("aguja1.png", 1000);
    aguja2  = loadResizedImage("aguja2.png", 1000);

    for (int i = 0; i < numFrames; i++) {
      images[i] = loadResizedImage("mano" + nf(i, 4) + ".png", 1200);
    }
  }

  // ===== UPDATE FÍSICO =====
  void actualizar() {
    angulo += velocidad;

    if (acelerando) {
      velocidad *= factorAceleracion;
    }
  }

  // ===== DRAW =====
  void dibujar() {

    image(fondo, width/2, height/2);

    updateAnimation();
    dibujarReloj();
    drawAnimation();

    switch (estado) {

      case INIT:
        edc.setGain(-10); // ajusta si quieres
        edc.loop();
        estado = RUNNING;
        break;

      case RUNNING:
        actualizar();
        break;

      case ACELERANDO:
        actualizar();

        if (millis() - tiempoInicioAceleracion >= duracionAceleracion) {
          estado = FINALIZANDO;
        }
        break;

      case FINALIZANDO:
        edc.pause();
        estadoGeneral = ESCENA1;
        break;
    }
  }

  // ===== RELOJ =====
  void dibujarReloj() {

    image(relojIn, cx, cy);

    pushMatrix();
    translate(cx + 600, cy);
    rotate(angulo);
    imageMode(CORNER);
    image(aguja1, -aguja1.width, -aguja1.height / 2);
    popMatrix();

    pushMatrix();
    translate(cx + 750, cy);
    rotate(angulo * 0.6);
    imageMode(CORNER);
    image(aguja2, -aguja2.width, -aguja2.height / 2);
    popMatrix();

    imageMode(CENTER);
  }

  // ===== INPUT =====
  void botonPulsado() {
    int ahora = millis();

    if (!animPlaying && ahora - ultimoClick < intervaloDobleClick) {
      animPlaying = true;
      animFinished = false;
      currentFrame = 0;
      lastFrameTime = millis();
    }

    ultimoClick = ahora;
  }

  // ===== ANIMACIÓN =====
  void updateAnimation() {
    if (!animPlaying || animFinished) return;

    if (millis() - lastFrameTime >= FRAME_INTERVAL) {
      lastFrameTime = millis();
      currentFrame++;

      if (currentFrame == 3 && estado == RUNNING) {
        acelerando = true;
        tiempoInicioAceleracion = millis();
        estado = ACELERANDO;
      }

      if (currentFrame >= numFrames) {
        currentFrame = numFrames - 1;
        animFinished = true;
        animPlaying = false;
      }
    }
  }

  void drawAnimation() {
    image(images[currentFrame], width / 2 - 500, height / 2 + 200);
  }
}
